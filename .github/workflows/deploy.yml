name: Deploy

on:
  pull_request:
    types: [opened, synchronize, closed]
    branches:
      - master

  workflow_dispatch:
    inputs:
      action:
        description: 'Deployment action'
        required: false
        default: ''

concurrency:
  group: ${{ github.ref }}

env:
  BRANCH: ${{ github.head_ref || github.ref }}
  IS_FEATURE: ${{ startsWith(github.head_ref, 'feature/') && !(contains(github.head_ref, 'tests')) && !(contains(github.head_ref, 'subtask')) }}
  ACTION: ${{ inputs.action || github.event.action }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    if:  env.ACTION != 'closed' #&& env.IS_FEATURE == 'true'
    
    steps:
      - uses: actions/checkout@v2

      - name: Start deploy
        shell: bash
        run: |
          echo Starting deployment
          printf "%q" "${{ toJSON(github) }}"

      - name: Deploy...
        shell: bash
        run: sleep 5s

      - name: Deploy finished
        run: echo Deploying in response to ${{ github.event_name }} action ${{ github.event.action }}. IsFeature = ${{ env.IS_FEATURE }}...

  destroy:
    runs-on: ubuntu-latest
    if: env.ACTION == 'closed'

    steps:
      - name: Start destroy
        run: echo Calling GitHub API to invoke destroy workflow

      - name: Trigger destroy
        uses: benc-uk/workflow-dispatch@v1
        with:
          workflow: Destroy
          token: ${{ secrets.DISPATCH_TOKEN }}
